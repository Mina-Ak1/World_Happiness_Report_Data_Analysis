---
title: "Exam 2"
author: "Mina Akhondzadeh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Introduction to World Happiness Report Data


The World Happiness Report is an annual publication that ranks countries based on happiness levels, using various socio-economic and psychological factors. It relies on survey data and statistical analysis to assess global well-being and the factors that contribute to it.
The report uses data from surveys conducted by Gallup and other organizations to measure happiness levels worldwide. 

- country: The name of the country.

- region: The geographical region to which the country belongs 

- score: The country's overall happiness score

- gdp_per_capita: A measure of the country's economic output per person, which is a key factor in determining overall well-being.

- social_support: A measure of the social network and support available to individuals in the country.

- healthy_life_expectancy: The average number of years a person is expected to live in good health.

- freedom_to_make_life_choices: A measure of how free individuals feel to make their own life decisions.

- generosity: The level of generosity, often measured by charitable donations.

- perceptions_of_corruption: A measure of how corrupt a country's institutions are perceived to be.

- year

Libraries
```{r}
library(ggplot2)
library(reshape2)
```



We read the dataset.
```{r}
years <- rep(2015:2023)

df <- data.frame()

for (year in years) {
  df1 <- read.csv(paste0("WHR_", year, ".csv"))
  
  df1$year <- year
  
  df <- rbind(df, df1)
}

```


Prepare data
```{r}
library(dplyr)

df[df == "N/A"] <- NA

df <-  na.omit(df)

df <- df %>% mutate(perceptions_of_corruption = as.numeric(perceptions_of_corruption))

df <-  na.omit(df)
```



Prepare X and y values. 
```{r}
X <- df[,-c(1, 2, 3, 10)]
y <- df[, c(3)]

cor_matrix <- cor(df[, 3:10])
ggplot(melt(cor_matrix), aes(x = Var1, y = Var2, fill = value)) +
geom_tile() +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0) +
  labs(title = "Correlation Heatmap", x = "Variables", y = "Variables", fill = "Correlation") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, color = "white"),
    axis.text.y = element_text(color = "white"),
    axis.title.x = element_text(color = "white"),
    axis.title.y = element_text(color = "white"),
    plot.title = element_text(color = "white", hjust = 0.5),
    plot.background = element_rect(fill = "#262626", color = NA),
    panel.background = element_rect(fill = "#262626", color = NA),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white")
  ) +
  coord_fixed()
```





```{r}
par(bg = "#262626",        
    col.main = "white",    
    col.lab = "white",     
    col.axis = "white",    
    col = "white")         

# Plot the histogram
hist(df$happiness_score,
     main = "Distribution of Happiness Score",
     xlab = "Happiness Score",
     col = "lightblue",    # Bar fill color
     border = "white")

axis(1, col = "white", col.ticks = "white", col.axis = "white")  
axis(2, col = "white", col.ticks = "white", col.axis = "white")
```


```{r}
par(mar = c(5, 10, 3, 2), 
    bg = "#262626",        
    col.main = "white",   
    col.lab = "white",     
    col.axis = "white",  
    col = "white")
colors <- rainbow(length(unique(df$region)))

boxplot(happiness_score ~ region, data = df, 
        main = "Happiness Score by Region",
        xlab = "Happiness Score", 
        ylab = "", 
        col = colors,  
        border = "white",
        las = 1,        
        horizontal = TRUE,
        cex.axis = 0.8,  
        cex.main = 1.2)

```

```{r}
par(pin = c(4, 3), 
    bg = "#262626",        
    col.main = "white",   
    col.lab = "white",     
    col.axis = "white",  
    col = "white")

region_colors <- as.factor(df$region)
palette <- rainbow(length(levels(region_colors)))

# Plot colored by region
plot(df$gdp_per_capita, df$happiness_score, 
     main = "Happiness Score vs. GDP per Capita",
     xlab = "GDP per Capita", ylab = "Happiness Score",
     col = palette[region_colors], pch = 19)

# Add a legend
legend("topright", legend = levels(region_colors), 
       col = palette, pch = 19, cex = 0.7, 
       xpd = TRUE, inset = c(-0.55, 0))

axis(1, col = "white", col.ticks = "white", col.axis = "white")  
axis(2, col = "white", col.ticks = "white", col.axis = "white")
```

```{r}
par(pin = c(4, 3), 
    bg = "#262626",        
    col.main = "white",   
    col.lab = "white",     
    col.axis = "white",  
    col = "white")


plot(df$gdp_per_capita, df$social_support, 
     main = "Social Support vs. GDP per Capita",
     xlab = "GDP per Capita", ylab = "Social Support",
     col = "purple", pch = 19)


axis(1, col = "white", col.ticks = "white", col.axis = "white")  
axis(2, col = "white", col.ticks = "white", col.axis = "white")
```
```{r}
par(pin = c(4, 3), 
    bg = "#262626",        
    col.main = "white",   
    col.lab = "white",     
    col.axis = "white",  
    col = "white")

plot(df$happiness_score, df$healthy_life_expectancy, 
     main = "Healthy Life Expectancy vs. Happiness Score",
     xlab = "Happiness Score", ylab = "Healthy Life Expectancy",
     col = "lightblue", pch = 19)

axis(1, col = "white", col.ticks = "white", col.axis = "white")  
axis(2, col = "white", col.ticks = "white", col.axis = "white")
```






## PCA

For PCA we will standardize our data to ensure that all variables contribute equally to the PCA calculation.
```{r}
X <- as.matrix(scale(X))
```

Then we need to find the eigenvectors of covariance of matrix X using function eigen(), and then get the vectors attribute:
```{r}
eigen_X <- eigen(cov(X))
eigen_X_vectors <- eigen_X$vectors
eigen_X_values <- eigen_X$values
```

Then we multiply eigenvectors by matrix X to get the principal components (transformed X):
```{r}
transformed_X <- X %*% eigen_X_vectors 
```

Then we plot the eigenvalues
```{r}
par(pin = c(4, 3),          
    bg = "#262626",          
    col.main = "white",      
    col.lab = "white",       
    col.axis = "white",      
    col = "white")

plot(rep(1:6), eigen_X_values, main="Eigen Values", pch = 16, col = "magenta",
     xlab='Index')

axis(1, col = "white", col.axis = "white")  
axis(2, col = "white", col.axis = "white")
```


```{r}
total_variance <- sum(eigen_X_values)
proportion_variance <- eigen_X_values / total_variance
cumulative_variance <- cumsum(proportion_variance)

proportion_variance_df <- data.frame(eigen_values = eigen_X_values,
                                     proportion_of_variance = proportion_variance,
                                     cumulative_proportion = cumulative_variance)
proportion_variance_df
```
 


Some PC plots of X


```{r}
plot_data <- data.frame(
  PC1 = transformed_X[, 1],
  PC2 = transformed_X[, 2],
  PC3 = transformed_X[, 3],
  PC4 = transformed_X[, 4],
  score = y,
  gdp = df$gdp_per_capita,
  generosity = df$generosity,
  corruption = df$perceptions_of_corruption
  
)

color_scale <- scale_color_gradientn(colors = c("red", "yellow", "green", "purple"))

custom_theme <- theme(
  panel.background = element_rect(fill = "#262626", color = NA),
  plot.background = element_rect(fill = "#262626", color = NA),
  axis.text = element_text(color = "white"),
  axis.title = element_text(color = "white"),
  plot.title = element_text(color = "white", size = 14, hjust = 0.5),
  legend.text = element_text(color = "white"),
  legend.title = element_text(color = "white"),
  legend.background = element_rect(fill = "#262626", color = NA),
  legend.key = element_rect(fill = "#262626", color = NA),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank()
)

plot1 <- ggplot(plot_data, aes(x = PC1, y = PC2, color = score)) +
  geom_point() +
  color_scale +
  labs(title = "PC1 vs PC2", x = "PC1", y = "PC2", color = "Score") +
  custom_theme

plot2 <- ggplot(plot_data, aes(x = PC1, y = PC3, color = gdp)) +
  geom_point() +
  color_scale +
  labs(title = "PC1 vs PC3", x = "PC1", y = "PC3", color = "GDP") +
  custom_theme

plot3 <- ggplot(plot_data, aes(x = PC2, y = PC3, color = generosity)) +
  geom_point() +
  color_scale +
  labs(title = "PC2 vs PC3", x = "PC2", y = "PC3", color = "Generosity") +
  custom_theme

plot4 <- ggplot(plot_data, aes(x = PC2, y = PC4, color = corruption)) +
  geom_point() +
  color_scale +
  labs(title = "PC2 vs PC4", x = "PC2", y = "PC4", color = "Corruption") +
  custom_theme

library(gridExtra)
grid.arrange(plot1, plot2, plot3, plot4, ncol = 2)

```


```{r}
library(plotly)
color_scale <- list(
  list(0, "red"),
  list(0.33, "yellow"),
  list(0.67, "green"),
  list(1, "purple")
)

plot_ly(plot_data, 
        x = ~PC1, 
        y = ~PC2, 
        z = ~PC3, 
        type = "scatter3d", 
        mode = "markers",
        marker = list(size = 3, 
                      color = df$perceptions_of_corruption, 
                      colorscale = color_scale,
                      colorbar = list(title = "Corruption"))) %>%
  layout(
    scene = list(
      xaxis = list(title = "PC1", color = "white"),
      yaxis = list(title = "PC2", color = "white"),
      zaxis = list(title = "PC3", color = "white"),
      bgcolor = "#262626"
    ),
    paper_bgcolor = "#262626",
    plot_bgcolor = "#262626",
    font = list(color = "white")
  )

```


```{r}
color_scale <- list(
  list(0, "red"),
  list(0.33, "yellow"),
  list(0.67, "green"),
  list(1, "purple")
)

plot_ly(plot_data, 
        x = ~PC1, 
        y = ~PC2, 
        z = ~PC4, 
        type = "scatter3d", 
        mode = "markers",
        marker = list(size = 3, 
                      color = df$freedom_to_make_life_choices, 
                      colorscale = color_scale,
                      colorbar = list(title = "Freedom"))) %>%
  layout(
    scene = list(
      xaxis = list(title = "PC1", color = "white"),
      yaxis = list(title = "PC2", color = "white"),
      zaxis = list(title = "PC4", color = "white"),
      bgcolor = "#262626"
    ),
    paper_bgcolor = "#262626",
    plot_bgcolor = "#262626",
    font = list(color = "white")
  )
```


```{r}
vectors <- eigen_X_vectors[,1:4]
rownames(vectors) <- colnames(X)
vectors

```




We would like to visualize how each original variable (feature) is related to the principal components.
```{r}
par(bg = "#262626", col.main = "white", col.lab = "white", col.axis = "white", col = "white", pin = c(4, 4))

cor_trans_X  <- cor(cbind(transformed_X[,1:2], X))     
cor_trans_X   <-  cor_trans_X[-c(1,2), 1:2] 

plot(cor_trans_X[, 1], cor_trans_X[, 2],  xlab = "PC1", ylab = "PC2", 
     xlim = c(-1, 1), ylim = c(-1, 1),
     pch = 16, col = "magenta", 
     main = "PC1 vs. PC2")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "lightblue", lty = 2)

text(cor_trans_X[, 1], cor_trans_X[, 2], labels = colnames(X), col = "green", pos = 3, cex = 0.8)

abline(h = 0, v = 0, col = "gray", lty = 3)

```

PC1 has negative







```{r}
par(bg = "#262626", col.main = "white", col.lab = "white", col.axis = "white", col = "white", pin = c(4, 4))

cor_trans_X  <- cor(cbind(transformed_X[,c(3, 4)], X))     
cor_trans_X   <-  cor_trans_X[-c(1,2), 1:2] 

plot(cor_trans_X[, 1], cor_trans_X[, 2],  xlab = "PC3", ylab = "PC4", 
     xlim = c(-1, 1), ylim = c(-1, 1),
     pch = 16, col = "magenta", 
     main = "PC3 vs. PC4")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "lightblue", lty = 2)

text(cor_trans_X[, 1], cor_trans_X[, 2], labels = colnames(X), col = "green", pos = 3, cex = 0.8)

abline(h = 0, v = 0, col = "gray", lty = 3)
```

```{r}
par(bg = "#262626", col.main = "white", col.lab = "white", col.axis = "white", col = "white", pin = c(4, 4))

cor_trans_X  <- cor(cbind(transformed_X[,c(1, 3)], X))     
cor_trans_X   <-  cor_trans_X[-c(1,2), 1:2] 

plot(cor_trans_X[, 1], cor_trans_X[, 2],  xlab = "PC1", ylab = "PC3", 
     xlim = c(-1, 1), ylim = c(-1, 1),
     pch = 16, col = "magenta", 
     main = "PC1 vs. PC3")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "lightblue", lty = 2)

text(cor_trans_X[, 1], cor_trans_X[, 2], labels = colnames(X), col = "green", pos = 3, cex = 0.8)

abline(h = 0, v = 0, col = "gray", lty = 3)
```






```{r}
par(pin = c(4, 4))
cor_trans_X  <- cor(cbind(transformed_X[, 1:2], X))     
cor_trans_X   <-  cor_trans_X[-c(1,2), 1:2] 

plot(cor_trans_X[, 1], cor_trans_X[, 2],  xlab = "PC1", ylab = "PC2", 
     xlim = c(-1, 1), ylim = c(-1, 1),
     pch = 16, col = "magenta", 
     main = "PC1 vs. PC2")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "lightblue", lty = 2)

text(cor_trans_X[, 1], cor_trans_X[, 2], labels = colnames(X), col = "darkgreen", pos = 3, cex = 0.8)

abline(h = 0, v = 0, col = "gray", lty = 3)
```



```{r}
par(pin = c(4, 4))

cor_trans_X  <- cor(cbind(transformed_X[,c(3, 4)], X))     
cor_trans_X   <-  cor_trans_X[-c(1,2), 1:2] 

plot(cor_trans_X[, 1], cor_trans_X[, 2],  xlab = "PC3", ylab = "PC4", 
     xlim = c(-1, 1), ylim = c(-1, 1),
     pch = 16, col = "magenta", 
     main = "PC3 vs. PC4")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "lightblue", lty = 2)

text(cor_trans_X[, 1], cor_trans_X[, 2], labels = colnames(X), col = "darkgreen", pos = 3, cex = 0.8)

abline(h = 0, v = 0, col = "gray", lty = 3)
```

```{r}
par(pin = c(4, 4))

cor_trans_X  <- cor(cbind(transformed_X[,c(1, 3)], X))     
cor_trans_X  <- cor_trans_X[-c(1,2), 1:2] 

plot(cor_trans_X[, 1], cor_trans_X[, 2],  xlab = "PC1", ylab = "PC3", 
     xlim = c(-1, 1), ylim = c(-1, 1),
     pch = 16, col = "magenta", 
     main = "PC1 vs. PC3")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "lightblue", lty = 2)

text(cor_trans_X[, 1], cor_trans_X[, 2], labels = colnames(X), col = "darkgreen", pos = 3, cex = 0.8)

abline(h = 0, v = 0, col = "gray", lty = 3)
```







#Factor Analysis

load libraries
```{r}
library(psych)
library(GPArotation)
```


The maximum number of factors we can include, ensuring that the degrees of freedom are not zero or negative, is k = 2. The formula for the degrees of freedom d is:
```{r}
k <- 2
p <- ncol(X)
d <-  0.5 * (p - k)^2 - 0.5 * (p + k)
d
```





Perform factor analysis using maximum likelihood and varimax rotation with 2 factors
```{r}
fa_model <- factanal(X, factors=2, n.obs=nrow(X) , rotation = "varimax", covmat = cor(X))
print(fa_model)
```


Perform factor analysis using maximum likelihood and varimax rotation with 1 factors
```{r}
fa_model <- factanal(X, factors=1, n.obs=nrow(X) , rotation = "varimax", covmat = cor(X))
print(fa_model)
```



```{r}
fa_model <- factanal(X, factors=2, n.obs = nrow(X), rotation = "varimax", covmat = cor(X))

load <- fa_model$loadings                           # estimated factor loadings
fa_loading   <-  fa_model$loadings[1:6,] # the estimated factor loadings matrix
communality  <- diag(fa_loading %*% t(fa_loading))           # communalities are calculated
table  <- cbind(fa_loading, communality)
table
```






Factor Loadings of Factor 1 vs Factor 2
```{r}
par(bg = "#262626", col.main = "white", col.lab = "white", col.axis = "white", col = "white", pin = c(4, 4))

plot(fa_model$loadings[, 1], fa_model$loadings[, 2],
     xlab = "Factor 1 (ML1)", ylab = "Factor 2 (ML2)", 
     main = "Factor Loadings on Factor 1 and Factor 2", pch = 16, col = "magenta",
     xlim = c(-1, 1), ylim = c(-1, 1))
text(fa_model$loadings[, 1], fa_model$loadings[, 2], 
     labels = rownames(fa_model$loadings), pos = 3, cex = 0.7, col = "cyan")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "yellow", lty = 2)

abline(h = 0, v = 0, col = "white", lty = 3)


```

```{r}
par(pin = c(4, 4))

plot(fa_model$loadings[, 1], fa_model$loadings[, 2],
     xlab = "Factor 1 (ML1)", ylab = "Factor 2 (ML2)", 
     main = "Factor Loadings on Factor 1 and Factor 2", pch = 16, col = "magenta",
     xlim = c(-1, 1), ylim = c(-1, 1))
text(fa_model$loadings[, 1], fa_model$loadings[, 2], 
     labels = rownames(fa_model$loadings), pos = 3, cex = 0.7, col = "blue")

ucircle <- cbind(cos(seq(0, 2 * pi, length.out = 100)), sin(seq(0, 2 * pi, length.out = 100)))
lines(ucircle, col = "orange", lty = 2)

abline(h = 0, v = 0, col = "gray", lty = 3)
```







